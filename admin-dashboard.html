<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Amazon Africa - Admin Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f8fafc;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #111827;
    }
    .form-section, .table-section, .status-section {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
    }
    button:hover { background: #1e40af; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background: #e5e7eb; }
    .action-btn {
      margin: 0 3px;
      padding: 5px 8px;
      font-size: 0.9em;
    }
    .delete { background: #dc2626; }
    .delete:hover { background: #991b1b; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- üü© Existing Form Section -->
  <div class="form-section">
    <h2>Add / Update Order</h2>
    <form id="orderForm">
      <input type="hidden" id="orderId">
      <input type="text" id="sender_name" placeholder="Sender Name" required>
      <input type="text" id="sender_country" placeholder="Sender Country" required>
      <input type="text" id="receiver_name" placeholder="Receiver Name" required>
      <input type="text" id="country" placeholder="Receiver Country" required>
      <input type="text" id="track_id" placeholder="Track ID" required>
      <input type="text" id="goods" placeholder="Goods" required>
      <input type="number" id="amount" placeholder="Amount" required>

      <select id="status">
        <option value="pending">Pending</option>
        <option value="in transit">In Transit</option>
        <option value="delivered">Delivered</option>
      </select>

      <button type="submit">Save</button>
    </form>
  </div>

  <!-- üü¶ NEW SECTION: Quick Edit Status -->
  <div class="status-section">
    <h2>Edit Status</h2>
    <p>Enter a valid Track ID and select a new status to quickly update order status.</p>
    <input type="text" id="track_id_edit" placeholder="Enter Track ID" required>
    <select id="status_edit">
      <option value="pending">Pending</option>
      <option value="in transit">In Transit</option>
      <option value="delivered">Delivered</option>
    </select>
    <button id="updateStatusBtn">Update Status</button>
    <p id="statusMessage" style="margin-top:10px; font-weight:bold;"></p>
  </div>

  <!-- üü® Existing Table Section -->
  <div class="table-section">
    <h2>All Orders</h2>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Sender</th>
          <th>Receiver</th>
          <th>Track ID</th>
          <th>Goods</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://uareyvicfwneodbzjgwo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhcmV5dmljZnduZW9kYnpqZ3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MTEzODksImV4cCI6MjA3NzA4NzM4OX0.L_o53GwxnN3q3XMhq1X9VtFNRbydWmU_qz01eTuyO8I";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Ensure only admin can access
    if (localStorage.getItem("isAdmin") !== "true") {
      alert("Access denied!");
      window.location.href = "admin-login.html";
    }

    const form = document.getElementById("orderForm");
    const tableBody = document.querySelector("#ordersTable tbody");
    const orderIdInput = document.getElementById("orderId");

    // CREATE / UPDATE FULL ORDER
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const orderData = {
        sender_name: sender_name.value,
        sender_country: sender_country.value,
        receiver_name: receiver_name.value,
        country: country.value,
        track_id: track_id.value,
        goods: goods.value,
        amount: parseFloat(amount.value),
        status: status.value.toLowerCase(),
      };

      if (orderIdInput.value) {
        await supabase.from("orders").update(orderData).eq("id", orderIdInput.value);
        orderIdInput.value = "";
      } else {
        await supabase.from("orders").insert([orderData]);
      }

      form.reset();
      loadOrders();
    });

    // READ
    async function loadOrders() {
      const { data, error } = await supabase.from("orders").select("*").order("id", { ascending: false });
      if (error) return console.error(error);

      tableBody.innerHTML = data.map(order => `
        <tr>
          <td>${order.id}</td>
          <td>${order.sender_name}</td>
          <td>${order.name}</td>
          <td>${order.track_id}</td>
          <td>${order.goods}</td>
          <td>‚Ç¶${order.amount}</td>
          <td>${order.status}</td>
          <td>
            <button class="action-btn" onclick='editOrder(${JSON.stringify(order)})'>‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteOrder(${order.id})">üóëÔ∏è</button>
          </td>
        </tr>
      `).join("");
    }

    // UPDATE existing (edit button)
    window.editOrder = (order) => {
      orderId.value = order.id;
      sender_name.value = order.sender_name;
      sender_country.value = order.sender_country;
      name.value = order.name;
      country.value = order.country;
      track_id.value = order.track_id;
      goods.value = order.goods;
      amount.value = order.amount;
      status.value = (order.status || "").toLowerCase();
    };

    // DELETE
    window.deleteOrder = async (id) => {
      if (confirm("Are you sure you want to delete this order?")) {
        await supabase.from("orders").delete().eq("id", id);
        loadOrders();
      }
    };

    // üÜï QUICK STATUS UPDATE LOGIC
    const updateStatusBtn = document.getElementById("updateStatusBtn");
    const statusMsg = document.getElementById("statusMessage");

    updateStatusBtn.addEventListener("click", async () => {
      const trackId = document.getElementById("track_id_edit").value.trim();
      const newStatus = document.getElementById("status_edit").value.toLowerCase();

      if (!trackId) {
        statusMsg.style.color = "red";
        statusMsg.textContent = "‚ö†Ô∏è Please enter a Track ID.";
        return;
      }

      const { data, error } = await supabase
        .from("orders")
        .update({ status: newStatus })
        .eq("track_id", trackId);

      if (error) {
        console.error(error);
        statusMsg.style.color = "red";
        statusMsg.textContent = "‚ùå Failed to update status.";
      } else if (data.length === 0) {
        statusMsg.style.color = "orange";
        statusMsg.textContent = "‚ö†Ô∏è No order found with that Track ID.";
      } else {
        statusMsg.style.color = "green";
        statusMsg.textContent = "‚úÖ Status updated successfully!";
        loadOrders();
      }
    });

    loadOrders();
  </script>
</body>
</html>
